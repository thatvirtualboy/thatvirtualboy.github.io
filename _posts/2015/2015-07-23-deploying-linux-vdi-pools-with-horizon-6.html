---
layout: post
title: Deploying Linux VDI Pools with Horizon 6
date: '2015-07-23T07:44:00.000-07:00'
author: thatvirtualboy
excerpt: "Horizon 6 brought us many exciting changes. One of the more memorable ones is the addition of support for certified Linux Guests. At the time of this writing, Horizon 6 supports RHEL 6.6, Ubuntu 12.04, CentOS 6.6, and Neoukylin 6/6U1."
tags:
- ubuntu
- vmware
- linux
- horizon6
- horizon
- vdi
modified_time: '2017-08-05T20:47:33.805-07:00'
blogger_id: tag:blogger.com,1999:blog-733606464149134140.post-708415532865903238
blogger_orig_url: https://www.thatvirtualboy.com/2015/07/deploying-linux-vdi-pools-with-horizon-6.html
redirect_from: /2015/07/deploying-linux-vdi-pools-with-horizon-6.html
---

<a href="https://thatvirtualboy.files.wordpress.com/2015/07/linux.png"><img alt="Linux" class="aligncenter wp-image-188 size-thumbnail" height="150" src="https://thatvirtualboy.files.wordpress.com/2015/07/linux.png?w=150" width="150" /></a><b>See the updated version for Horizon 7 <a href="http://www.thatvirtualboy.com/2016/09/deploying-linux-vdi-pools-with-horizon.html">here</a>.</b><br /><br />Horizon 6 brought us many exciting changes. One of the more memorable ones is the addition of support for certified Linux Guests. At the time of this writing, Horizon 6 supports RHEL 6.6, Ubuntu 12.04, CentOS 6.6, and Neoukylin 6/6U1.<br /><br />NOTE: newer versions may work just fine, but aren't&nbsp;<em>certified</em> to work. Meaning, if you want VMware Support to back you up, you should probably stick with the versions listed above.<br /><br />To get started using Linux with your VDI implementation, make sure you have the prereqs:<br /><ul><li>vSphere 5.5 U2 or vSphere 6.0 and later</li><li>Horizon 6.1.1 or later</li><li>Horizon Client 3.4 or later</li><li>Note that Zero and mobile are not supported at this time</li></ul>For the purposes of this post, we'll be using Ubuntu 12.04 with vSphere 5.5 U2e and Horizon 6.1.1. I'm going to cover building both a manual pool, as well as a bulk linked clone pool.<br /><ol><li>First, let's build the template VM.<br /><ol><br /><li>Create a new VM and install Ubuntu 12.04 with 2vCPU and 2GB of RAM<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/ubuntu-settings.png"><img alt="ubuntu-settings" class="alignnone wp-image-211 size-full" height="400" src="https://thatvirtualboy.files.wordpress.com/2015/07/ubuntu-settings.png" width="382" /></a></li></ol></li><br /><li>After it's installed, run Ubuntu's Update Manager and get the system&nbsp;fully patched (be sure to decline the 14.04 dist upgrade)<br /><img alt="ubuntu-update-manager" class="alignnone wp-image-212 size-large" height="485" src="https://thatvirtualboy.files.wordpress.com/2015/07/ubuntu-updates.png?w=660" width="640" /></li><br /><li>Now we'll install VMware Tools<ol><li>Right click VM &gt; <strong>All vCenter Actions</strong> &gt; <strong>Guest OS</strong> &gt; <strong>Install VMware Tools</strong></li><li>Click <strong>Mount</strong></li><li>Once mounted, you should see a folder&nbsp;pop up<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/tools-mounted.png"><img alt="tools-mounted" class="alignnone wp-image-209 size-large" height="478" src="https://thatvirtualboy.files.wordpress.com/2015/07/tools-mounted.png?w=660" width="640" /></a></li><br /><li>I like to copy the VMwareTools-9*.tar.gz file to the Desktop.<ol><li>Right click the .tar.gz and choose <strong>Copy to</strong> &gt; <strong>Desktop</strong></li></ol></li><li>Right click the .tar.gz on the desktop and choose <strong>Extract Here</strong></li><li>Open Terminal, change directory into the folder, and run <strong>vmware-install.pl<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/tools-install.png"><img alt="tools-install" class="alignnone wp-image-208 size-large" height="479" src="https://thatvirtualboy.files.wordpress.com/2015/07/tools-install.png?w=660" width="640" /></a></strong>To accept defaults, hit Enter for each question unless you understand what you're customizing.</li><br /><li><strong>Reboot</strong> Ubuntu</li></ol></li><br /><li>Ensure DNS is working to and from the View Connection Server<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/dns.png"><img alt="DNS" class="alignnone size-medium wp-image-204" height="130" src="https://thatvirtualboy.files.wordpress.com/2015/07/dns.png?w=300" width="300" /></a> <a href="https://thatvirtualboy.files.wordpress.com/2015/07/dns-broker.png"><img alt="DNS-broker" class="alignnone size-medium wp-image-203" height="87" src="https://thatvirtualboy.files.wordpress.com/2015/07/dns-broker.png?w=300" width="300" /></a></li><br /><li>Proceed to building a manual pool or bulk linked clone pool below.</li></ol><blockquote><br /><div style="text-align: center;"><strong>Building a manual Pool</strong></div></blockquote><ol><br /><li>Now we're ready to install the Linux View Agent!<br /><ol><br /><li>NOTE: if using Windows Server 2012/R2 AD, follow the step 8 on page 11 from <a href="https://pubs.vmware.com/horizon-61-view/topic/com.vmware.ICbase/PDF/horizon-611-linux-desktops.pdf" target="_blank">this doc</a></li><br /><li>NOTE: if your Ubuntu VM doesn't have internet access, follow step 9 on page 12 from the above doc<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/agent-download.png"><img alt="agent-download" class="alignnone wp-image-200 size-large" height="482" src="https://thatvirtualboy.files.wordpress.com/2015/07/agent-download.png?w=660" width="640" /></a></li></ol></li><br /><li>Unpack the tar ball, and run <em>install_viewagent.sh -b -d -u -p</em> appropriately:<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/agent-install.png"><img alt="agent-install" class="alignnone wp-image-202 size-large" height="480" src="https://thatvirtualboy.files.wordpress.com/2015/07/agent-install.png?w=660" width="640" /></a><br /><ol><br /><li>When the install completes successfully, it should prompt you to reboot or logout<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/agent-install-successful.png"><img alt="agent-install-successful" class="alignnone wp-image-201 size-large" height="480" src="https://thatvirtualboy.files.wordpress.com/2015/07/agent-install-successful.png?w=660" width="640" /></a></li></ol></li><br /><li><strong>Reboot</strong> Ubuntu</li><br /><li>Back in the View Admin page, ensure the VM is registered to View<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/registered.png"><img alt="registered" class="alignnone wp-image-206 size-large" height="594" src="https://thatvirtualboy.files.wordpress.com/2015/07/registered.png?w=660" width="640" /></a></li><br /><li>In&nbsp;the View Admin page, create a new <strong>Manual Desktop Pool </strong>and add the VM.<br /><ol><br /><li>NOTE: This pool can <strong>only</strong> contain Linux VMs</li></ol></li></ol><blockquote><br /><div style="text-align: center;"><strong>Building a&nbsp;</strong><b>bulk Linked Clone pool</b></div><br /></blockquote><div style="text-align: left;">Building a Linux linked clone pool is not quite as simple as creating a Windows linked clone pool (yet .. crossing fingers). Essentially we automate the cloning process with PowerCLI, then add the created linked clones to a manual pool within View.</div><ol><br /><li style="text-align: left;">Create a View Administrative user (viewuser) in the Ubuntu Guest OS. This account is dedicated for installing the View Agent.<br /><ol><br /><li style="text-align: left;">Settings &gt; User Accounts &gt; Create Admin User<br /><img alt="new-user" class="alignnone size-large wp-image-247" height="479" src="https://thatvirtualboy.files.wordpress.com/2015/07/new-user1.png?w=660" width="640" /></li><br /><li style="text-align: left;">The account will remain disabled until you set a password. Hover your mouse over Password under Login Options and set the password.</li><br /><li style="text-align: left;">Edit <strong>/etc/sudoers</strong> and add <span style="color: maroon;">v</span><em><span style="color: maroon;">iewuser ALL=(ALL) NOPASSWD:ALL</span></em><a href="https://thatvirtualboy.files.wordpress.com/2015/07/sudoers1.png"><img alt="sudoers" class="alignnone wp-image-227 size-large" height="426" src="https://thatvirtualboy.files.wordpress.com/2015/07/sudoers1.png?w=660" width="660" /></a></li></ol></li><br /><li>Shutdown the VM and take a vCenter Snapshot</li><br /><li>Build the guest customization script<br /><ol><br /><li>From vSphere Web Client Home page, click <strong>Rules and Profiles</strong> &gt; <strong>Customization Specification Manager</strong></li><br /><li>Click the <strong>Create a New Specification</strong> button</li><br /><li>Select <strong>Linux</strong> for the target OS and enter your desired input<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/custom-spec-name.png"><br /></a><a href="https://thatvirtualboy.files.wordpress.com/2015/07/custom-spec-name.png"><img alt="custom-spec-name" class="alignnone wp-image-224 size-large" height="376" src="https://thatvirtualboy.files.wordpress.com/2015/07/custom-spec-name.png?w=660" width="640" /></a> <a href="https://thatvirtualboy.files.wordpress.com/2015/07/custom-spec-review.png"><img alt="custom-spec-review" class="alignnone wp-image-225 size-large" height="375" src="https://thatvirtualboy.files.wordpress.com/2015/07/custom-spec-review.png?w=660" width="640" /></a></li><br /><li>Note the specification name you entered as this will be referenced in your <strong>CloneVMs.csv</strong> file later</li></ol></li><br /><li>On your PowerCLI machine, create a folder to store the Horizon Linux PowerCLI scripts</li><br /><li>Download these three&nbsp;files to your folder (Sometimes my file server is down for maintenance): <strong><a href="https://rakdom.asuscomm.com/owncloud/index.php/s/brzYDgIwP8NFd4T" target="_blank">CloneVMs.csv</a>,</strong>&nbsp;<a href="https://rakdom.asuscomm.com/owncloud/index.php/s/CO6YqKwahzBSRRs" target="_blank"><strong>CloneVMs.ps1 </strong></a>and<strong> <a href="https://rakdom.asuscomm.com/owncloud/index.php/s/avOh1POYL0icLD7" target="_blank">InstallAgent.ps1</a></strong>. If you'd rather copy the text from the official VMware docs, you'll want to copy it from the <a href="https://pubs.vmware.com/horizon-61-view/topic/com.vmware.horizon-view.linuxdesktops.doc/GUID-E6825232-3188-4507-B757-0CF743047282.html" target="_blank">HTML version here</a>. You'll also want to include the Linux Agent installer in your folder for later.<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/files.png"><img alt="files" class="alignnone wp-image-223 size-full" height="97" src="https://thatvirtualboy.files.wordpress.com/2015/07/files.png" width="591" /></a></li><br /><li>Customize <strong>CloneVMs.csv</strong> to match the details of your environment - in my file, I'm only building 2 VMs</li></ol><br /><pre style="text-align: left;">VMName,Parentvm,CustomSpec,Datastore,Host,FromSnapshot,DeleteIfPresent<br />linux-001,Ubuntu-Template,linuxagent,share,192.168.1.174,snap1,TRUE<br />linux-002,Ubuntu-Template,linuxagent,share,192.168.1.174,snap1,TRUE</pre><br /><div style="text-align: left;">Once&nbsp;this file is tweaked to match your environment, we can starting running the PowerCLI scripts</div><ol><br /><li style="text-align: left;">Launch PowerCLI and change directory into the folder we created&nbsp;containing the scripts</li><br /><li style="text-align: left;">Invoke the <strong>CloneVMs.ps1</strong> script and answer the prompts<a href="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_linked_creation.png"><br /></a><a href="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_linked_creation.png"><img alt="powerCLI_linkedclone" class="alignnone wp-image-232 size-large" height="316" src="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_linkedclone.png?w=660" width="640" /></a><br />You should start seeing the clones show up in vCenter<a href="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_linked_creation.png"><img alt="powerCLI_linked_creation" class="alignnone wp-image-230 size-large" height="344" src="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_linked_creation.png?w=660" width="640" /></a></li><br /><li style="text-align: left;">Once the linked clones have been created, we'll run the Agent Installation script<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_agent_install3.png"><img alt="powerCLI_Agent_install3" class="alignnone size-large wp-image-238" height="255" src="https://thatvirtualboy.files.wordpress.com/2015/07/powercli_agent_install3.png?w=660" width="640" /></a></li><br /><li style="text-align: left;">If you run into any errors, check out the troubleshooting section below.</li><br /><li style="text-align: left;">Assuming this completes successfully, you should see the machines show up as registered VMs in View Administrator: <strong>View Configuration</strong> &gt; <strong>Registered Machines</strong> &gt; <strong>Other<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/registered_linked.png"><img alt="registered_linked" class="alignnone size-large wp-image-239" height="463" src="https://thatvirtualboy.files.wordpress.com/2015/07/registered_linked.png?w=660" width="640" /></a></strong>NOTE: at this point you shouldn't see a Pool assigned already like my screenshot. We'll perform that next</li><br /><li>Now let's create a manual pool to add our freshly baked Ubuntu Linked Clones<br /><ol><br /><li><strong>Catalog</strong> &gt; <strong>Desktop Pools</strong> &gt; <strong>Add</strong></li><br /><li>Select <strong>Manual Desktop Pool</strong></li><br /><li>Pick your assignment preferences</li><br /><li>On Machine Source page, choose <strong>Other Sources</strong></li><br /><li>After selecting your VMs, don't change the <strong>Remote Display Protocol</strong> - it needs to be left default.</li><br /><li>NOTE: Don't add Windows VMs to this pool, it will cause the Linux machines to become unavailable</li></ol></li><br /><li>Victory! Ensure you're on the latest Horizon Client before connecting<br /><a href="https://thatvirtualboy.files.wordpress.com/2015/07/success.png"><img alt="success!" class="alignnone size-large wp-image-240" height="448" src="https://thatvirtualboy.files.wordpress.com/2015/07/success.png?w=660" width="640" /></a></li></ol><br /><br /><hr /><blockquote><br /><div style="text-align: center;"><strong>Troubleshooting VM cloning and Agent install</strong></div><br /></blockquote><br /><div style="text-align: left;"><strong>When running the InstallAgent.ps1 script, you see the error&nbsp;</strong></div><br /><div style="text-align: left;"><span style="color: maroon;"><em>sudo: no tty present and no&nbsp;askpass program specified</em></span><br /><span style="color: maroon;"><em>Sorry, try again<br /><img alt="askpass" class="alignnone size-full wp-image-246" height="231" src="https://thatvirtualboy.files.wordpress.com/2015/07/askpass.png" width="639" /></em></span></div><div style="text-align: left;">:: Double check your <strong>sudoers</strong> file we edited earlier. There is likely a typo, or the username wasn't entered in all lowercase.</div><br /><br /><div style="text-align: left;"><strong>When running InstallAgent.ps1 you see the error</strong><br /><span style="color: maroon;"><em>Failed to authenticate with the guest operating system<br /><img alt="powerCLI-agent-install-failed-to-athenticate" class="alignnone size-large wp-image-248" height="318" src="https://thatvirtualboy.files.wordpress.com/2015/07/powercli-agent-install-failed-to-athenticate.png?w=660" width="640" /></em></span><br />:: Verify password is correct. Check username is lowercase in script as that's the default case for new accounts<br /><br /><strong>When running InstallAgent.ps1 you see the error</strong><span style="color: maroon;"><em>Hostname not resolvable, terminating installation</em></span><br /><span style="color: maroon;"><em>Ensure host is registered with name service or listed in hosts file<br /><img alt="troubleshoot-hostname-resolveable" class="alignnone size-large wp-image-249" height="282" src="https://thatvirtualboy.files.wordpress.com/2015/07/troubleshoot-hostname-resolveable.png?w=642" width="640" /></em></span><br /><br />:: Ensure your Custom Specification file is properly referenced and the vm naming is correct<br /><br /><strong>View Administrator shows VMs as Agent Unreachable<br /><img alt="troubleshoot-unreachable" class="alignnone size-large wp-image-250" height="280" src="https://thatvirtualboy.files.wordpress.com/2015/07/troubleshoot-unreachable.png?w=660" width="640" /></strong><br />:: Check out the official troubleshooting doc for this one <a href="https://pubs.vmware.com/horizon-61-view/topic/com.vmware.horizon-view.linuxdesktops.doc/GUID-127FFC83-BD23-4A91-A074-480595DFB027.html" target="_blank">here</a>.</div>
