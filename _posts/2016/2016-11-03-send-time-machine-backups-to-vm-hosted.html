---
layout: post
title: Send Time Machine backups to a VM hosted in Windows
date: '2016-11-03T01:47:00.000-07:00'
author: thatvirtualboy
excerpt: "I've successfully configured Time Machine backups over my home network using VMware Workstation, Ubuntu, and a 1 TB WD drive. A big thanks to HowToGeek for their Raspberry Pi post for the inspiration and to Netatalk's Wiki. Here we go!"
tags:
- OSX
- ubuntu
- apple
- linux
- bacon
- workstation
modified_time: '2017-08-04T22:33:57.745-07:00'
blogger_id: tag:blogger.com,1999:blog-733606464149134140.post-6862386789026575200
blogger_orig_url: https://www.thatvirtualboy.com/2016/11/send-time-machine-backups-to-vm-hosted.html
redirect_from: /2016/11/send-time-machine-backups-to-vm-hosted.html
---

I've successfully configured Time Machine backups over my home network using VMware Workstation, Ubuntu, and a 1 TB WD drive. A big thanks to HowToGeek for their Raspberry Pi <a href="http://www.howtogeek.com/276468/how-to-use-a-raspberry-pi-as-a-networked-time-machine-drive-for-your-mac/" target="_blank">post</a>&nbsp;for the inspiration and to Netatalk's <a href="http://netatalk.sourceforge.net/wiki/index.php/Install_Netatalk_3.1.10_on_Ubuntu_14.04_Trusty" target="_blank">Wiki</a>.&nbsp;Here we go!<br /><h3><img alt="screen-shot-2016-11-03-at-8-44-29-am" class="alignnone size-full wp-image-2329" height="452" src="https://thatvirtualboy.files.wordpress.com/2016/11/screen-shot-2016-11-03-at-8-44-29-am.png" width="640" />:: Prerequisites</h3><ul><br /><li>Windows (using Windows 10 in this tutorial)</li><br /><li>VMware Workstation (using 12.5 Pro)</li><br /><li>Linux ISO (using Ubuntu 16.04 mini.iso)</li><br /><li>Dedicated backup drive (using a 1TB WD) formatted as HFS+</li><br /><li>macOS Seirra</li></ul><h3>:: Prepare your drive</h3><br />Format your hard drive to be HFS+. This can be done by booting to any linux live disk and using <em>gparted</em>. You'll likely need to install <strong>hfsprogs</strong> and <strong>hfsplus</strong> to enable the formatting.<br /><br />When attached to your Windows Host system, Windows won't mount this drive in&nbsp;Explorer, but you can still see it in Windows Disk Management to ensure it's working properly. Here it shows as <strong>Disk 0</strong><img alt="screen-shot-2016-11-02-at-9-22-21-pm" class="alignnone size-full wp-image-2298" height="250" src="https://thatvirtualboy.files.wordpress.com/2016/11/screen-shot-2016-11-02-at-9-22-21-pm.png" width="640" /><br /><br />Choose a mount point that your backup server will use for the drive. I'll use <strong>/media/tm</strong><br />Choose a user that will connect to your backup server from the Mac. <strong>&lt;your-user&gt;</strong><br /><br />Save these for later.<br /><h3>:: Setting up the dedicated backup server</h3><br />I run my personal servers on a Windows 10 box under VMware Workstation. It's plain simple, easy to administer and maintain, and works great for home needs. Because I like dedicating my servers to individual VMs, I wanted a small VM to attach my 1 TB backup drive to - something with a small footprint as I won't need to interact with the OS much. This is why I chose to use Ubuntu's mini.iso<br /><ol><br /><li>In Workstation, create a new VM using the <strong>mini.iso</strong>. The only 'options' I chose to install with it were <strong>opensshserver</strong>&nbsp;for management, and <strong>samba</strong> (might use this in the future). My VM uses 512 MB of RAM and 1vCPU.</li><br /><li>Obtain&nbsp;HFS+ support by running<br /><pre>sudo apt-get install hfsprogs hfsplus</pre></li><br /><li>Let's take a moment to add&nbsp;our disk to the VM. I chose for my VM to have direct access to the physical disk as its primary purpose will be for backups.<img alt="screen-shot-2016-11-02-at-9-25-48-pm" class="alignnone size-full wp-image-2303" height="372" src="https://thatvirtualboy.files.wordpress.com/2016/11/screen-shot-2016-11-02-at-9-25-48-pm.png" width="429" /><br /><img alt="screen-shot-2016-11-02-at-9-26-09-pm" class="alignnone size-full wp-image-2302" height="372" src="https://thatvirtualboy.files.wordpress.com/2016/11/screen-shot-2016-11-02-at-9-26-09-pm.png" width="427" /></li><br /><li>Now boot the VM back up, and mount the drive<br /><pre>sudo mount -t hfsplus -o force,rw /dev/sd* /media/tm</pre><br />You should also add this to <strong>/etc/fstab</strong> so it mounts properly at boot<br /><pre>/dev/sd* /media/tm hfsplus force,rw,user,auto 0 0</pre></li><br /><li>Setup permissions for your user that will connect to the server<br /><pre>sudo chown -R root:users <span style="color: #339966;">/media/tm</span><br />sudo chmod -R g+rwx <span style="color: #339966;">/media/tm</span><br />sudo usermod -a -G users&nbsp;<span style="color: #339966;">&lt;your-user&gt;</span></pre></li><br /><li>Once that's done, follow Netatalk's <a href="http://netatalk.sourceforge.net/wiki/index.php/Install_Netatalk_3.1.10_on_Ubuntu_14.04_Trusty" target="_blank">Wiki</a> on setting up v3.1.10 (current at time of writing) on Ubuntu 14.04 (my server is using Ubuntu 16.04 and I can attest it works). Here are the commands for reference:<br /><pre>sudo apt-get install build-essential libevent-dev libssl-dev libgcrypt11-dev libkrb5-dev libpam0g-dev libwrap0-dev libdb-dev libtdb-dev libmysqlclient-dev avahi-daemon libavahi-client-dev libacl1-dev libldap2-dev libcrack2-dev systemtap-sdt-dev libdbus-1-dev libdbus-glib-1-dev libglib2.0-dev libio-socket-inet6-perl tracker libtracker-sparql-1.0-dev libtracker-miner-1.0-dev</pre><br /><pre>wget http://prdownloads.sourceforge.net/netatalk/netatalk-3.1.10.tar.gz</pre><br /><pre>tar -xf netatalk-3.1.10.tar.gz</pre><br /><pre>cd netatalk-3.1.10</pre><br /><pre>./configure --with-init-style=debian-systemd --without-libevent --without-tdb --with-cracklib --enable-krbV-uam --with-pam-confdir=/etc/pam.d --with-dbus-sysconf-dir=/etc/dbus-1/system.d --with-tracker-pkgconfig-version=1.0</pre><br /><pre>make</pre><br /><pre>sudo make install</pre><br />&nbsp;</li><li>Now edit your <strong>/etc/nsswitch.conf</strong> and append&nbsp;<strong>mdns4 mdns</strong> to the end of the hosts file so it looks like this<br /><pre>hosts: files mdns4_minimal [NOTFOUND=return] dns mdns4 mdns</pre><br />&nbsp;</li><li>Create the file&nbsp;<strong>/etc/avahi/services/afpd.service</strong> with the below contents<br /><pre>&lt;?xml version="1.0" standalone='no'?&gt;&lt;!--*-nxml-*--&gt;<br />&lt;!DOCTYPE service-group SYSTEM "avahi-service.dtd"&gt;<br />&lt;service-group&gt;<br />   &lt;name replace-wildcards="yes"&gt;%h&lt;/name&gt;<br />   &lt;service&gt;<br />     &lt;type&gt;_afpovertcp._tcp&lt;/type&gt;<br />     &lt;port&gt;548&lt;/port&gt;<br />   &lt;/service&gt;<br />   &lt;service&gt;<br />     &lt;type&gt;_device-info._tcp&lt;/type&gt;<br />     &lt;port&gt;0&lt;/port&gt;<br />     &lt;txt-record&gt;model=TimeCapsule&lt;/txt-record&gt;<br />   &lt;/service&gt;<br />&lt;/service-group&gt;</pre>&nbsp;</li><br /><li>Setup&nbsp;the Netatalk AFP File Server config file&nbsp;<strong><strong><strong>/usr/local/etc/afp.conf</strong></strong></strong><br /><pre>[<span style="color: #339966;">&lt;your-user&gt;</span>]<br /> path = /home/<span style="color: #339966;">&lt;your-user&gt;</span><br /> rolist = <span style="color: #339966;">&lt;your-user&gt;</span><br /><br />[Global]<br /> mimic model = TimeCapsule6,106<br /><br />[Time Machine]<br /> path = /media/tm <span style="color: #339966;">(or whatever your mount point is)</span><br /> time machine = yes</pre></li><br /><li>Run the init scripts in this order<br /><pre>sudo /etc/init.d/avahi-daemon start</pre><br /><pre>sudo service netatalk start</pre></li><li>Add services to default runlevels<br /><pre>sudo update-rc.d avahi-daemon defaults<br />sudo update-rc.d netatalk defaults</pre></li><br /><li>Back on your Mac, add your Ubuntu machine to <strong>/etc/hosts</strong><br /><pre>x.x.x.x &lt;ubuntu-hostname&gt;</pre></li><br /><li>At this point, you should be able to connect to the server via hostname. From Finder Window, press <strong>command+K&nbsp;</strong>and enter the server address&nbsp;<strong>afp://&lt;ubuntu-hostname&gt;</strong>&nbsp;</li><br /><li>Open Time Machine Preferences and select the Time Machine disk</li></ol>If you don't see your disk in Time Machine preferences, ensure that it was mounted as <strong>read/write</strong> on the backup server. Good luck!
