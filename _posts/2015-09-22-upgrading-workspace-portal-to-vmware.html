---
layout: post
title: Upgrading Workspace Portal to VMware Identity Manager (vIDM)
date: '2015-09-22T00:51:00.000-07:00'
author: thatvirtualboy
excerpt: "In this post, we’ll be upgrading an HA Cluster of Workspace Portal 2.1.1 to vIDM 2.4 per the official documentation instructions. Some technical knowledge of pgAdmin and other tools is assumed in the official guide, so hopefully this post can help fill the gaps."
tags:
- vmware
- workspace
- vIDM
modified_time: '2017-08-03T10:14:47.813-07:00'
blogger_id: tag:blogger.com,1999:blog-733606464149134140.post-3497244485815932685
blogger_orig_url: https://www.thatvirtualboy.com/2015/09/upgrading-workspace-portal-to-vmware.html
---

In this post, we'll be upgrading an <a href="https://blogs.vmware.com/horizontech/2014/11/workspace-portal-2-1-ha-cluster-using-internal-db.html" target="_blank">HA Cluster</a> of Workspace Portal 2.1.1 to vIDM 2.4 per the <a href="http://pubs.vmware.com/vidm-24/topic/com.vmware.wsp-upgrade.doc_24/GUID-ED0E3D60-2085-49AC-888E-B3E8FEADD36D.html" target="_blank">official documentation instructions</a>. Some technical knowledge of pgAdmin and other tools is assumed in the official guide, so hopefully this post can help fill the gaps.<br/><h5>Step 1: Break the HA configuration</h5><br/>Upgrading requires us to temporarily revert to a single-node configuration which is a little daunting to hear, but fortunately it's much easier than reverting all the steps it took to create the cluster in the first place. If you don't have Workspace setup in HA mode, then you can move on to Step 2.<br/><ol><br/>	<li>Verify you see more than 1 node listed when running <span id="GUID-ED0E3D60-2085-49AC-888E-B3E8FEADD36D__cmdname_B888C05F3CD84BBBBD6352BFF2706532" class="cmdname">curl -XGET 'http://localhost:9200/_cluster/health?pretty=true' // This means there are multiple nodes in the cluster, just like you configured it to be.</span><br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/2.png"><img class="alignnone size-medium wp-image-549" src="https://thatvirtualboy.files.wordpress.com/2015/09/2.png?w=300" alt="2" width="300" height="124" /></a></li><br/>	<li>Launch pgAdmin and connect to the primary node<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/3.png"><img class="alignnone size-medium wp-image-550" src="https://thatvirtualboy.files.wordpress.com/2015/09/3.png?w=229" alt="3" width="229" height="300" /></a></li><br/>	<li>Expand <strong>Databases</strong> &gt; <strong>saas</strong> &gt; <strong>Schemas</strong> &gt; <strong>saas</strong> &gt; <strong>Tables<br/></strong><a href="https://thatvirtualboy.files.wordpress.com/2015/09/1.png"><img class="alignnone size-medium wp-image-551" src="https://thatvirtualboy.files.wordpress.com/2015/09/1.png?w=300" alt="1" width="300" height="154" /></a></li><br/>	<li>Find the Table called <strong>ServiceInstance</strong> and right click &gt; <strong>View Data</strong> &gt; <strong>View Top 100 Rows</strong><br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/4.png"><img class="alignnone size-medium wp-image-552" src="https://thatvirtualboy.files.wordpress.com/2015/09/4.png?w=300" alt="4" width="300" height="239" /></a></li><br/>	<li>Your nodes should all be listed here. Go ahead and delete all rows <strong>except for the master node<br/></strong><a href="https://thatvirtualboy.files.wordpress.com/2015/09/5.png"><img class="alignnone size-medium wp-image-553" src="https://thatvirtualboy.files.wordpress.com/2015/09/5.png?w=300" alt="5" width="300" height="66" /></a></li><br/>	<li>Perform the same steps for the <strong>FailoverConfiguration</strong> Table, but <strong><strong>make sure to delete all rows</strong></strong></li><br/>	<li>Run <span id="GUID-ED0E3D60-2085-49AC-888E-B3E8FEADD36D__cmdname_B888C05F3CD84BBBBD6352BFF2706532" class="cmdname">curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'</span> again and ensure only 1 node is returned<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/7.png"><img class="alignnone size-medium wp-image-554" src="https://thatvirtualboy.files.wordpress.com/2015/09/7.png?w=300" alt="7" width="300" height="116" /></a></li><br/>	<li>Now we need to update the Load Balancer in place to only use the master node. This will likely be different for most people since not everyone uses the same LB. In my case, I'm using NGINX as a Reverse Proxy. Consult your Load Balancer's documentation to achieve this step.</li><br/></ol><br/><h5>Step 2: Perform an Online Upgrade</h5><br/><ol><br/>	<li>Verify the prereqs. There are <a href="http://pubs.vmware.com/vidm-24/topic/com.vmware.wsp-upgrade.doc_24/GUID-94BFB22E-4B27-4F13-9D0B-D1F0EDF99F53.html#GUID-94BFB22E-4B27-4F13-9D0B-D1F0EDF99F53" target="_blank">actually quite a few</a> but the big ones are:<br/><ol><br/>	<li>Verify there is at least 2.5GB of space on root available<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/8.png"><img class="alignnone size-medium wp-image-556" src="https://thatvirtualboy.files.wordpress.com/2015/09/8.png?w=300" alt="8" width="300" height="51" /></a></li><br/>	<li>Take a snapshot of the Workspace vApp</li><br/>	<li>Take a snapshot of the Workspace Database (if on an external DB server)</li><br/>	<li>Verify you can reach vapp-updates.vmware.com (where the update will be downloaded from)<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/9.png"><img class="alignnone size-medium wp-image-557" src="https://thatvirtualboy.files.wordpress.com/2015/09/9.png?w=300" alt="9" width="300" height="35" /></a></li><br/>	<li>In the Map User Attributes page, make <strong>distinguishedName</strong> a required attribute, if you plan to sync Citrix-published resources (XenApp) to vIDM.</li><br/>	<li>Unjoin the master node from the Domain (Required if if coming from Workspace 2.1.0 and if planning on configuring HA cluster... Workspace 2.1.1 does not require this).</li><br/></ol><br/></li><br/>	<li>On the Appliance Console, run the following commands to verify vIDM 2.4 shows available:<br/><em>/usr/local/horizon/update/updatemgr.hzn updateinstaller</em><br/><em>/usr/local/horizon/update/updatemgr.hzn check</em><br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/92.png"><img class="alignnone size-medium wp-image-558" src="https://thatvirtualboy.files.wordpress.com/2015/09/92.png?w=300" alt="92" width="300" height="187" /></a></li><br/>	<li>Run <em>/usr/local/horizon/update/updatemgr.hzn update</em> to update the appliance<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/93.png"><img class="alignnone size-medium wp-image-559" src="https://thatvirtualboy.files.wordpress.com/2015/09/93.png?w=300" alt="93" width="300" height="187" /></a></li><br/>	<li>If it completes successfully, you should be prompted to reboot the VM<br/><img class="alignnone wp-image-564 size-medium" src="https://thatvirtualboy.files.wordpress.com/2015/09/screen-shot-2015-09-15-at-9-02-15-pm.png?w=300" alt="Screen Shot 2015-09-15 at 9.02.15 PM" width="300" height="211" /></li><br/></ol><br/>Congratulations! Workspace has now been upgraded to vIDM! You should be able to confirm this in the blue console window.<br/><br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/screen-shot-2015-09-15-at-9-13-55-pm.png"><img class="alignnone wp-image-566 size-medium" src="https://thatvirtualboy.files.wordpress.com/2015/09/screen-shot-2015-09-15-at-9-13-55-pm.png?w=300" alt="Screen Shot 2015-09-15 at 9.13.55 PM" width="300" height="202" /></a><br/><h5>Reconfigure the HA Cluster</h5><br/>If you would like to reconfigure the HA cluster, follow the below steps:<br/><ol><br/>	<li>In the vSphere console, clone the master node. It may save time if you power down the master node before cloning.</li><br/>	<li>Name the clone whatever you want, and we'll configure it's FQDN after.<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/94.png"><img class="alignnone wp-image-567 size-medium" src="https://thatvirtualboy.files.wordpress.com/2015/09/94.png?w=300" alt="94" width="300" height="283" /></a></li><br/>	<li>Once the clone operation is complete, edit the vAPP properties of the VM to configure it's FQDN (Hostname) and IP. These must be unique values (as in, different than the master node).<br/><a href="https://thatvirtualboy.files.wordpress.com/2015/09/95.png"><img class="alignnone size-medium wp-image-568" src="https://thatvirtualboy.files.wordpress.com/2015/09/95.png?w=300" alt="95" width="300" height="266" /><br/></a></li><br/>	<li>Click ok and power on (first power on the master node before powering on the clone if need be).</li><br/>	<li>The initial boot will check for a new hostname and IP and if they're different than the master, it will pass as a clone, then get autoconfigured as necessary. Once the boot is complete and the blue console screen is visible, login as root and type the following commands to ensure you see all the nodes in the cluster (in this case, 2 nodes)<br/><pre>curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'</pre><br/><pre>rabbitmqctl cluster_status</pre><br/></li><br/>	<li>Now add the clone back into your Load Balancer's configuration. Once again, you must consult your LB's documentation in order to complete this step.</li><br/>	<li>You can perform this cloning operation as many times as needed to build out your HA cluster. You can also perform these steps at any time - the HA cluster does not have to be built out right away.</li><br/></ol><br/><blockquote>What about my old slave-nodes from 2.1.1?  -- These can be deleted or stored for backup/reference use. The new vIDM cluster will not be referencing or using them in any way.</blockquote><br/><h5>Post-Upgrade Configuration</h5><br/>The official post-upgrade steps <a href="http://pubs.vmware.com/vidm-24/topic/com.vmware.wsp-upgrade.doc_24/GUID-079B929D-04EC-4979-AC2D-CACD3DBA2701.html" target="_blank">can be found here</a>, but here are some additional things to check:<br/><ul><br/>	<li>Ensure admin users and end-user accounts can both login to the portal. If you have trouble using one of the domain users to log in, then in an upgraded environment, append <strong>/SAAS/login/0</strong> to the login URL using the local <strong>admin</strong> account. For example, if your login URL is https://myco.example.com, you would change it to <strong>https://myco.example.com/SAAS/login/0</strong>.</li><br/>	<li>Re-join the domain if you had left it prior the upgrade</li><br/>	<li>Verify apps and desktops launch as expected (a View sync may be a good idea at this point - Keep in mind View Sync should only be enabled on 1 node)</li><br/>	<li>Upgrade end-user's Desktop Clients to version 2.4. Be sure to <strong>uninstall</strong> the current Workspace Desktop Client, then install the 2.4 client.</li><br/></ul><br/>I hope you've found this post helpful in upgrading your Workspace Portal deployment to vIDM! Let me know in the comments how it went!
