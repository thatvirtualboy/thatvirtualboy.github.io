---
layout: post
title: Plex DVR Postprocessing Script
date: '2017-11-28T14:39:00.003-08:00'
author: thatvirtualboy
excerpt: "PLEX is the media power house in my home, managing Movies, TV Shows, Home Videos, Music, Picture Backups, and now Live TV DVR. Check out my script which helps cut commercials and transcode your recordings!"
tags:
- plex
- bacon
modified_time: '2018-05-17T08:40:12.798-07:00'
thumbnail: https://4.bp.blogspot.com/-3x6HmEMCrss/Wh3mB57PrzI/AAAAAAAAvz0/EaOrlaXhKE41rmU7FT4BeghNIb1hvuYaQCLcBGAs/s72-c/plex-logo.png
blogger_id: tag:blogger.com,1999:blog-733606464149134140.post-2963823480421253559
blogger_orig_url: https://www.thatvirtualboy.com/2017/11/plex-dvr-postprocessing-script.html
redirect_from: /2017/11/plex-dvr-postprocessing-script.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-3x6HmEMCrss/Wh3mB57PrzI/AAAAAAAAvz0/EaOrlaXhKE41rmU7FT4BeghNIb1hvuYaQCLcBGAs/s1600/plex-logo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="460" data-original-width="1176" height="124" src="https://4.bp.blogspot.com/-3x6HmEMCrss/Wh3mB57PrzI/AAAAAAAAvz0/EaOrlaXhKE41rmU7FT4BeghNIb1hvuYaQCLcBGAs/s320/plex-logo.png" width="320" /></a></div><br /><br />I've been using Plex DVR the last couple months, testing the Plex Pass and Beta capabilities, and figuring ways to make it a solid solution for me and my family. The DVR aspect works well on the latest Beta release    1.10.0.4523, and the GUI is very simple to use. Setting up recordings and having them auto-added to my library works almost like magic.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-75RRbM1pXjQ/Wh3gVAA4hLI/AAAAAAAAvzY/MMd36DmgVosUnL_zCBX1OslKaXW_bAgQgCLcBGAs/s1600/Screen%2BShot%2B2017-11-28%2Bat%2B1.43.56%2BPM.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="920" data-original-width="1308" height="450" src="https://3.bp.blogspot.com/-75RRbM1pXjQ/Wh3gVAA4hLI/AAAAAAAAvzY/MMd36DmgVosUnL_zCBX1OslKaXW_bAgQgCLcBGAs/s640/Screen%2BShot%2B2017-11-28%2Bat%2B1.43.56%2BPM.png" width="640" /></a></div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />But amidst the magic, I had some requirements that took more than out-of-the-box configuration. My two requirements were<br /><br /><ol><li>Remove commercials</li><li>Reduce the final file size while preserving quality</li></ol><div>Through lots of trial and error (lots), I was able to provide Plex with a script that takes care of both of these requirements. This script is provided to Plex via its path on the server in the <i>DVR settings</i> of the web console. Here, you can see I have added the script <b>plex_pp.sh</b></div><div><b><br /></b></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-NaPVXd3Zt9k/Wh3fx6J68jI/AAAAAAAAvzQ/K-FGuBCHaMUNKzOsdYYOxFJg8fygccCKgCLcBGAs/s1600/Screen%2BShot%2B2017-11-28%2Bat%2B1.42.48%2BPM.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="974" data-original-width="1358" height="458" src="https://4.bp.blogspot.com/-NaPVXd3Zt9k/Wh3fx6J68jI/AAAAAAAAvzQ/K-FGuBCHaMUNKzOsdYYOxFJg8fygccCKgCLcBGAs/s640/Screen%2BShot%2B2017-11-28%2Bat%2B1.42.48%2BPM.png" width="640" /></a></div><div><br /></div><div><br /></div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />The Plex Pass beta build mentioned above introduced commercial cutting natively within the Plex GUI. For those just starting out with Plex DVR, this is a fantastic addition they've added, and will greatly reduce the technical challenges of implementing it yourself. This newly built-in feature is still, however, in beta and may come with some unwanted bugs.<br /><br />This script is a combination of information found online and tweaks for my needs (my household is mostly Apple products, hence the transcoding presets). All of this is maintained on my <a href="https://github.com/thatvirtualboy/plex" target="_blank">GitHub page</a>, so check there for the latest bits.<br /><b><br /></b><b>My Environment (not earth shattering by ANY means)</b><br /><br /><ul><li>PMS (latest Plex Pass Beta) running on a virtual Ubuntu 16.04</li><li>4vCPU / 2GB RAM</li><li>AMD A-10 6800k APU in host running Windows 10 Pro</li><li>HDHomeRun Connect Tuner</li></ul><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-5u2G8zsaOLo/Wh3ktHV_vDI/AAAAAAAAvzo/MJ7NRocwL5YszNvgQL0snb4H1vgNIGG2gCLcBGAs/s1600/Screen%2BShot%2B2017-11-28%2Bat%2B1.42.24%2BPM.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="658" data-original-width="1600" height="262" src="https://2.bp.blogspot.com/-5u2G8zsaOLo/Wh3ktHV_vDI/AAAAAAAAvzo/MJ7NRocwL5YszNvgQL0snb4H1vgNIGG2gCLcBGAs/s640/Screen%2BShot%2B2017-11-28%2Bat%2B1.42.24%2BPM.png" width="640" /></a></div><div><br /></div><br /><b>Prerequisites</b><br /><br /><ol><li>Comcut</li><ol><li>Comskip</li><li>ffmpeg</li></ol><li>Handbrake-CLI</li></ol><div>This script is used to run comcut on completed Plex DVR recordings, then transcode them using handbrake with the Apple TV 1080p preset.</div><div><br /></div><b>Shout out</b><br /><div>Original inspiration for this script came from <a href="http://forums.plex.tv/discussion/280289/plexdvr-post-processing-script-comcut-ccextractor-and-ffmpeg#latest" target="_blank">this post</a></div><div><br /></div><b>Usage</b><br /><div><ul><li>Be sure to change permissions on the .sh file, something like <b>chmod 777</b> or <b>u+x</b></li><li>Edit the script to put the paths to your Comcut and Handbrake-CLI locations. I've included mine as examples within the script</li></ul><div>--</div><div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#! /bin/bash</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Plex DVR Postprocessing</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Version 0.0.1</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># twitter.com/thatvirtualboy</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># www.thatvirtualboy.com</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># FIRST, RUN COMCUT TO REMOVE COMMERCIALS, THEN TRANSCODE AND COMPRESS</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">lockFile='/tmp/dvrProcessing.lock'</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">inFile="$1"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">tmpFile="$1.mp4"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">dvrPostLog='/tmp/dvrProcessing.log'</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">time=`date '+%Y-%m-%d %H:%M:%S'`</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">handbrake=/PATH/TO/YOUR/INSTALL (mine is /usr/bin/HandBrakeCLI)</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cut=/PATH/TO/YOUR/COMCUT/INSTALL (mine is /home/ryan/comchap/comcut)</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "'$time' Plex DVR Postprocessing script started" | tee $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Check if post processing is already running</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">while [ -f $lockFile ]</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">do</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; echo "'$time' $lockFile' exists, sleeping processing of '$inFile'" | tee -a $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; sleep 10</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">done</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Create lock file to prevent other post-processing from running simultaneously</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "'$time' Creating lock file for processing '$inFile'" | tee -a $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">touch $lockFile</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Run comcut</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "'$time' Comcut started on '$inFile'" | tee -a $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">$cut "$inFile"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Encode file to MP4 with handbrake-cli</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "'$time' Transcoding started on '$inFile'" | tee -a $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">$handbrake -i "$inFile" -o "$tmpFile" --preset="Apple 1080p30 Surround" --encoder-preset="veryfast" -O</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"># Overwrite original ts file with the transcoded file</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "'$time' File rename started" | tee -a $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mv -f "$tmpFile" "$inFile"</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#Remove lock file</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo "'$time' All done! Removing lock for '$inFile'" | tee -a $dvrPostLog</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">rm $lockFile</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">exit 0</span></div></div></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">--</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div><div><span style="font-family: inherit;">Once the recording is complete, the script will kickoff and get to work on the file before adding it to the Plex library. While the script is running, you'll see that the recording sits at a <b>100% complete </b>status until it's done.</span></div><div><span style="font-family: inherit;"><br /></span></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-S0Zz-8JXP9c/Wh3kdFlklJI/AAAAAAAAvzk/8ShuNCd2y_w9ElQEzqdO1K8QxbVpXV7xQCLcBGAs/s1600/Screen%2BShot%2B2017-11-28%2Bat%2B1.43.17%2BPM.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="956" data-original-width="1334" height="458" src="https://2.bp.blogspot.com/-S0Zz-8JXP9c/Wh3kdFlklJI/AAAAAAAAvzk/8ShuNCd2y_w9ElQEzqdO1K8QxbVpXV7xQCLcBGAs/s640/Screen%2BShot%2B2017-11-28%2Bat%2B1.43.17%2BPM.png" width="640" /></a></div><div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />If you have two shows recording back-to-back, this script will also process one recording at a time, to not tax your system.</div><div><br /></div><div>I hope you find this useful. Thanks for reading!</div>
