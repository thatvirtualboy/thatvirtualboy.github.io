---
layout: post
title: How to setup NGINX as a reverse proxy for Workspace Portal 2.1
date: '2014-11-20T14:44:00.000-08:00'
author: thatvirtualboy
excerpt: "In this post, we'll setup NGINX as a reverse proxy for Workspace Portal so users can connect from outside networks."
tags:
- nginx
- ssl
- workspace
- vIDM
modified_time: '2017-08-03T10:14:47.238-07:00'
blogger_id: tag:blogger.com,1999:blog-733606464149134140.post-7777604135120912182
blogger_orig_url: https://www.thatvirtualboy.com/2014/11/how-to-setup-nginx-as-reverse-proxy-for.html
redirect_from: /2014/11/how-to-setup-nginx-as-reverse-proxy-for.html
---

<div class="tr_bq">Per Workspace Portal's <a href="http://pubs.vmware.com/workspace-portal-21/topic/com.vmware.wsp-install_21/GUID-959E0EFF-AF1F-4479-A19C-98BAF813E73C.html" target="_blank">installation guide</a>,</div><br/><div class="tr_bq"></div><br/><span style="font-family:inherit;font-size:large;"><span style="color:#333333;line-height:18px;">During deployment, </span><span id="PRODUCTNAME_3D59143A3C31483D98AC3FFB4F99418B" style="color:#333333;line-height:18px;"><a href="https://www.blogger.com/null" name="PRODUCTNAME_3D59143A3C31483D98AC3FFB4F99418B"></a>Workspace</span><span style="color:#333333;line-height:18px;"> is set up inside the internal network. If you want to provide access to </span><span id="PRODUCTNAME_3D59143A3C31483D98AC3FFB4F99418B" style="color:#333333;line-height:18px;"><a href="https://www.blogger.com/null" name="PRODUCTNAME_3D59143A3C31483D98AC3FFB4F99418B"></a>Workspace</span><span style="color:#333333;line-height:18px;"> for users connecting from outside networks, you must install a load balancer, such as Apache, nginx, F5, and so on, in the DMZ.</span></span><br/><span style="color:#333333;font-family:Arial, Helvetica, sans-serif;font-size:12px;line-height:18px;"><br/></span>This process is unfortunately outside of VMware's Documentation scope as every environment is different and we do not recommend a particular vendor/service over another.<br/><br/>NGINX, however, is a free and robust option that can at least get you up and running for your external users fairly quickly. This won't be a comprehensive how-to, but should certainly be useful in getting you started!<br/><br/>In this example, we'll be using Ubuntu Server 12.04 for the NGINX server. I performed a default install and enabled only the OpenSSH service during install. Once Ubuntu is installed and has the desired IP and hostname, go ahead and install nginx: <a style="border-bottom-color:black;border-bottom-style:dotted;border-bottom-width:1px;color:black;font-family:monospace, serif;font-size:14px;text-decoration:none;" href="//nginx">sudo apt-get install nginx</a><br/><br/>Now you can configure <b>nginx.conf</b> to include all the reverse proxy information in a single file, however, in my setup, NGINX needs 3 things in order to work with Workspace:<br/><ol><br/>	<li>nginx.conf</li><br/>	<li>default.conf</li><br/>	<li>SSL Certificates</li><br/></ol><br/>Here is a copy of what my nginx.conf looks like: /etc/nginx/nginx.conf (HUGE thanks to Tomi Vakala from <a href="https://v-reality.info/2014/07/use-nginx-gateway-service-vmware-horizon-workspace/" target="_blank">vReality</a>)<br/><br/>_______________________________________<br/><span style="font-family:Courier New, Courier, monospace;"># nginx configuration file<br/># hws21</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;"># User to run nginx processes as. Ensure this user exists on your system!</span><br/><span style="font-family:Courier New, Courier, monospace;">user hadmin;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;"># Worker processes</span><br/><span style="font-family:Courier New, Courier, monospace;">worker_processes 4;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">error_log /var/log/nginx/error.log warn;</span><br/><span style="font-family:Courier New, Courier, monospace;">pid /var/run/nginx.pid;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">events {</span><br/><span style="font-family:Courier New, Courier, monospace;">    worker_connections 1024;</span><br/><span style="font-family:Courier New, Courier, monospace;">    multi_accept on;</span><br/><span style="font-family:Courier New, Courier, monospace;">    # Use epoll on Linux, kqueue on *BSD and Mac OS X</span><br/><span style="font-family:Courier New, Courier, monospace;">    use epoll;</span><br/><span style="font-family:Courier New, Courier, monospace;">}</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">http {</span><br/><span style="font-family:Courier New, Courier, monospace;">    include /etc/nginx/mime.types;</span><br/><span style="font-family:Courier New, Courier, monospace;">    default_type application/octet-stream;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    log_format main '$remote_addr - $remote_user [$time_local] "$request" '</span><br/><span style="font-family:Courier New, Courier, monospace;">                    '$status $body_bytes_sent "$http_referer" '</span><br/><span style="font-family:Courier New, Courier, monospace;">                    '"$http_user_agent" "$http_x_forwarded_for"';</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    access_log /var/log/nginx/access.log main;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    # Enable sendfile for improved performance on Linux</span><br/><span style="font-family:Courier New, Courier, monospace;">    sendfile on;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    # Enable nagle algorithm to buffer more data before sending</span><br/><span style="font-family:Courier New, Courier, monospace;">    tcp_nopush on;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    keepalive_timeout 65;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    # Setup client buffers</span><br/><span style="font-family:Courier New, Courier, monospace;">    client_body_buffer_size 256k;</span><br/><span style="font-family:Courier New, Courier, monospace;">    client_header_buffer_size 2k;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    # Enable gzip compression</span><br/><span style="font-family:Courier New, Courier, monospace;">    gzip             on;</span><br/><span style="font-family:Courier New, Courier, monospace;">    gzip_buffers     128 8k;</span><br/><span style="font-family:Courier New, Courier, monospace;">    gzip_min_length  512;</span><br/><span style="font-family:Courier New, Courier, monospace;">    gzip_proxied     any;</span><br/><span style="font-family:Courier New, Courier, monospace;">    gzip_types       text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;</span><br/><span style="font-family:Courier New, Courier, monospace;">    gzip_comp_level  3;</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;">    include /etc/nginx/conf.d/*.conf;</span><br/><span style="font-family:Courier New, Courier, monospace;">}</span><br/><span style="font-family:Courier New, Courier, monospace;"><br/></span><span style="font-family:Courier New, Courier, monospace;"># eof<br/>_____________________________________</span><br/><div></div><br/><div>Next, we need to configure the <b>default.conf</b> which we told <b>nginx.conf</b> to include toward the end of the file.</div><br/><div></div><br/><div>The <b>default.conf</b>  (/etc/nginx/conf.d/default.conf)  you'll <b>create</b> and <b>customize</b> for your environment. The things you'll need to customize are:</div><br/><div><br/><ol><br/>	<li>server_name (this is the public facing FQDN)</li><br/>	<li>ssl_certificate (your certificate's full chain)</li><br/>	<li>ssl_certificate_key</li><br/>	<li>proxy_pass (what nginx is proxying to - the internal Workspace instance name)</li><br/>	<li><span style="color:#990000;">[Updated] </span>proxy_redirect off;<br/>-- I originally missed number 5 here in my config and it caused issues when enabling Kerberos in my environment. More on proxy_redirect <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect" target="_blank">here</a></li><br/></ol><br/><div>________________________________________</div><br/></div><br/><div></div><br/><div><br/><div><span style="font-family:Courier New, Courier, monospace;"># /etc/nginx/conf.d/default.conf</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"># hws2.1</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">server {</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # IPv4 listen directive, enable SSL</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    listen 443 ssl;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    server_name workspace.vcloud.local;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    server_tokens off;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # Strict Transport Security (HSTS), force browser to use encrypted</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # connection to this site at all times</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    add_header Strict-Transport-Security "max-age=31536000;";</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # Configure SSL</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl on;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl_certificate /etc/ssl/workspace_chain.crt;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl_certificate_key /etc/ssl/workspace.key;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl_session_cache shared:SSL:50m;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl_session_timeout 10m;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl_prefer_server_ciphers on;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # Set list of preferred ciphers to enable use of ciphers with perfect</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # forward secrecy to improve security</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM- SHA384:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK';</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    # Reverse proxy directives</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    location / {</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_pass https://hws21.vcloud.local:443/;</span><br/><span style="font-family:Courier New, Courier, monospace;">        proxy_redirect off;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_set_header Host $host;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_set_header X-Real-IP $remote_addr;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_read_timeout 1800;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_connect_timeout 1800;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_http_version 1.1;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_max_temp_file_size 5m;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        # Increase proxy memory buffers</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_buffering on;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_buffer_size 32k;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_buffers 16 32k;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">        proxy_busy_buffers_size 32k;</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">    }</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;">}</span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"> </span></div><br/><div><span style="font-family:Courier New, Courier, monospace;"># eof</span></div><br/></div><br/><div>___________________________________</div><br/><div></div><br/><div>If you're not much of an SSL wizard, the following two links will be extremely useful in setting up an internal CA with openSSL, then generating your internally signed certs (assuming you don't have Third Party CA signed certs)</div><br/><div></div><br/><div><a href="http://pages.cs.wisc.edu/~zmiller/ca-howto/" target="_blank">How to setup a CA</a></div><br/><div><a href="https://www.sslshopper.com/article-most-common-openssl-commands.html" target="_blank">The Most Common OpenSSL commands</a></div><br/><div></div><br/><div>Once default.conf and nginx.conf have been configured, and your certificate is valid, you should be able to start nginx. If the service fails to start, it should indicate which component it's having an issue with, whether it's one of the .conf files themselves, or the provided certificate or key file.</div><br/><div></div><br/><div>The next steps would be to then login to the Workspace Configurator portal at https://:8443/cfg/setup</div><br/><div></div><br/><div>Click on <b>Install Certificate</b> &gt; <b>Terminate SSL on a Load Balancer</b>. Here you can install the root CA cert from the Load Balancer. Then under <b>Workspace FQDN</b> you can set your new public FQDN.</div><br/><div></div><br/><div>If you have issues changing your FQDN, check out this <a href="http://blogs.vmware.com/horizontech/2014/10/troubleshoot-workspace-portal-setup-issues-changing-fqdn.html" target="_blank">excellent troubleshooting blog on VMware Blogs</a></div><br/><div></div><br/><div></div><br/><div>Good luck!</div><br/><div></div>
